name: Agent Builder Agent3

on:
  schedule:
    - cron: "*/10 * * * *"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: agent-builder-agent3
  cancel-in-progress: false

jobs:
  build:
    runs-on: ${{ vars.USE_SELF_HOSTED_RUNNERS == 'true' && fromJSON('["self-hosted","agent-agent3"]') || 'ubuntu-latest' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Pick next eligible issue
        id: pick
        env:
          GH_TOKEN: ${{ github.token }}
          AGENT_LABEL: agent:agent3
        run: |
          set -euo pipefail
          bash .github/scripts/pick_issue.sh

      - name: Exit if agent already has in-progress issue
        if: steps.pick.outputs.HAS_IN_PROGRESS == 'true'
        run: |
          set -euo pipefail
          echo "agent:agent3 already has an in-progress issue; exiting."

      - name: Exit if no eligible issue
        if: steps.pick.outputs.HAS_IN_PROGRESS != 'true' && steps.pick.outputs.ISSUE_NUMBER == ''
        run: |
          set -euo pipefail
          echo "No eligible issue found for agent:agent3."

      - name: Claim issue
        if: steps.pick.outputs.ISSUE_NUMBER != ''
        env:
          GH_TOKEN: ${{ github.token }}
          ISSUE_NUMBER: ${{ steps.pick.outputs.ISSUE_NUMBER }}
        run: |
          set -euo pipefail
          bash .github/scripts/claim_issue.sh

      - name: Build prompt from issue + task profile
        if: steps.pick.outputs.ISSUE_NUMBER != ''
        env:
          GH_TOKEN: ${{ github.token }}
          ISSUE_NUMBER: ${{ steps.pick.outputs.ISSUE_NUMBER }}
        run: |
          set -euo pipefail
          ISSUE_TITLE="$(gh issue view "$ISSUE_NUMBER" --json title --jq '.title')"
          ISSUE_BODY="$(gh issue view "$ISSUE_NUMBER" --json body --jq '.body // ""')"
          {
            echo "You are builder agent: agent3."
            echo
            echo "Implement GitHub issue #${ISSUE_NUMBER}: ${ISSUE_TITLE}"
            echo
            echo "Issue body:"
            echo "${ISSUE_BODY}"
            echo
            echo "Execution requirements:"
            echo "- Follow AGENTS.md repository rules."
            echo "- Follow TASK-agent3.md ownership/boundaries/handoff requirements."
            echo "- Produce code changes for this issue only."
            echo "- Run relevant verification commands from AGENTS.md."
            echo "- Create/update PR_BODY.md in repo root with sections: Summary, Issue link, Tests run, Risk/rollback, Checklist."
            echo "- Include 'Fixes #${ISSUE_NUMBER}' in the title and PR_BODY.md."
            echo
            echo "Repository policy:"
            cat AGENTS.md
            echo
            echo "Task agent profile:"
            cat TASK-agent3.md
          } > PROMPT.md

      - name: Run Codex
        if: steps.pick.outputs.ISSUE_NUMBER != ''
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          prompt-file: PROMPT.md
          safety-strategy: drop-sudo
          sandbox: workspace-write

      - name: Detect code changes
        if: steps.pick.outputs.ISSUE_NUMBER != ''
        id: changes
        run: |
          set -euo pipefail
          if [[ -n "$(git status --porcelain -- . ':(exclude)PR_BODY.md' ':(exclude)PROMPT.md')" ]]; then
            echo "HAS_CHANGES=true" >> "$GITHUB_OUTPUT"
          else
            echo "HAS_CHANGES=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Unclaim and comment when no changes produced
        if: steps.pick.outputs.ISSUE_NUMBER != '' && steps.changes.outputs.HAS_CHANGES == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
          ISSUE_NUMBER: ${{ steps.pick.outputs.ISSUE_NUMBER }}
          MESSAGE: "Automation run completed but no changes were produced, so this issue has been returned to status:ready."
        run: |
          set -euo pipefail
          bash .github/scripts/unclaim_issue.sh
          bash .github/scripts/comment_issue.sh

      - name: Ensure PR body exists
        if: steps.pick.outputs.ISSUE_NUMBER != '' && steps.changes.outputs.HAS_CHANGES == 'true'
        env:
          ISSUE_NUMBER: ${{ steps.pick.outputs.ISSUE_NUMBER }}
        run: |
          set -euo pipefail
          if [[ ! -f PR_BODY.md ]]; then
            printf '%s\n' \
              'Summary' \
              "- Implemented automated changes for issue #${ISSUE_NUMBER}." \
              '' \
              'Issue link' \
              "- Fixes #${ISSUE_NUMBER}" \
              '' \
              'Tests run' \
              '- Not specified.' \
              '' \
              'Risk/rollback' \
              '- Low to medium. Revert this PR if regressions are observed.' \
              '' \
              'Checklist' \
              '- [x] Changes align with issue requirements.' \
              '- [ ] Add or update tests if needed.' > PR_BODY.md
          fi
          grep -q "Fixes #${ISSUE_NUMBER}" PR_BODY.md || echo "\nFixes #${ISSUE_NUMBER}" >> PR_BODY.md

      - name: Commit and push branch
        if: steps.pick.outputs.ISSUE_NUMBER != '' && steps.changes.outputs.HAS_CHANGES == 'true'
        env:
          ISSUE_NUMBER: ${{ steps.pick.outputs.ISSUE_NUMBER }}
        run: |
          set -euo pipefail
          timestamp="$(date +%Y%m%d%H%M%S)"
          branch="codex/agent3/issue-${ISSUE_NUMBER}-${timestamp}"
          echo "BRANCH_NAME=${branch}" >> "$GITHUB_ENV"
          git config user.name "codex-bot"
          git config user.email "codex-bot@users.noreply.github.com"
          git checkout -b "${branch}"
          git add -A ':!PR_BODY.md' ':!PROMPT.md'
          git commit -m "feat(agent3): resolve issue #${ISSUE_NUMBER}"
          git push -u origin "${branch}"

      - name: Create PR
        if: steps.pick.outputs.ISSUE_NUMBER != '' && steps.changes.outputs.HAS_CHANGES == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          ISSUE_NUMBER: ${{ steps.pick.outputs.ISSUE_NUMBER }}
          BRANCH_NAME: ${{ env.BRANCH_NAME }}
        run: |
          set -euo pipefail
          issue_title="$(gh issue view "$ISSUE_NUMBER" --json title --jq '.title')"
          pr_title="[agent:agent3] Fixes #${ISSUE_NUMBER} - ${issue_title}"
          gh pr create \
            --base main \
            --head "${BRANCH_NAME}" \
            --title "${pr_title}" \
            --body-file PR_BODY.md \
            --label "codex-bot" \
            --label "agent:agent3"
